<div class="challenge-detail-container" *ngIf="challenge(); else loading">
  <!-- Header -->
  <div class="detail-header">
    <button class="back-btn" (click)="goBack()">â† Back</button>
    
    <div class="header-content">
      <div class="title-row">
        <h1>{{ challenge()!.name }}</h1>
        <div class="badges">
          <span class="type-badge" [class]="challenge()!.challengeType">
            {{ challengeService.getChallengeTypeLabel(challenge()!.challengeType) }}
          </span>
          <span class="goal-type-badge">
            {{ challengeService.getGoalTypeIcon(challenge()!.goalType) }}
            {{ challengeService.getGoalTypeLabel(challenge()!.goalType) }}
          </span>
          <span class="mode-badge" [class]="challenge()!.competitionMode">
            {{ challenge()!.competitionMode === 'collaborative' ? 'ğŸ¤' : 'ğŸ†' }}
          </span>
          <span class="locked-badge" *ngIf="challenge()!.isLocked">
            ğŸ”’ Locked
          </span>
        </div>
      </div>
      
      <p class="description" *ngIf="challenge()!.description">
        {{ challenge()!.description }}
      </p>
      
      <div class="target-info" *ngIf="challengeService.formatTargetValue(challenge()!)">
        <span class="target-value">
          ğŸ¯ Goal: {{ challengeService.formatTargetValue(challenge()!) }}
        </span>
      </div>

      <div class="meta-info">
        <span *ngIf="challenge()!.region">ğŸ“ {{ challenge()!.region }}</span>
        <span *ngIf="challenge()!.difficulty"
          [style.color]="challengeService.getDifficultyColor(challenge()!.difficulty)">
          {{ challenge()!.difficulty }}
        </span>
        <span *ngIf="challenge()!.startDate">ğŸš€ Started: {{ formatDate(challenge()!.startDate) }}</span>
        <span *ngIf="challenge()!.deadline">ğŸ“… Due: {{ formatDate(challenge()!.deadline) }}</span>
      </div>

      <!-- Join Code Section (for creators) -->
      <div class="join-code-section" *ngIf="challenge()!.createdByUserId === currentUserId()">
        <button class="toggle-code-btn" (click)="toggleJoinCode()">
          {{ showJoinCode() ? 'ğŸ”½' : 'â–¶ï¸' }} Join Code
        </button>
        <div class="join-code-display" *ngIf="showJoinCode()">
          <span class="join-code-value">{{ challenge()!.joinCode }}</span>
          <button class="copy-btn" (click)="copyJoinCode()" title="Copy join code">
            ğŸ“‹ Copy
          </button>
        </div>
      </div>
    </div>

    <div class="header-actions">
      <button class="join-btn" *ngIf="!challenge()!.isJoined" (click)="onJoinChallenge()">
        Join Challenge
      </button>
      <button class="leave-btn" *ngIf="challenge()!.isJoined" (click)="onLeaveChallenge()">
        Leave
      </button>
      <button class="lock-btn" *ngIf="challenge()!.createdByUserId === currentUserId() && !challenge()!.isLocked" (click)="onLockChallenge()">
        ğŸ”’ Lock Challenge
      </button>
    </div>
  </div>

  <!-- Progress Section -->
  <div class="progress-section" *ngIf="challenge()!.isJoined">
    <div class="progress-card">
      <div class="progress-header">
        <h3>{{ challenge()!.competitionMode === 'collaborative' ? 'Team Progress' : 'Your Progress' }}</h3>
        <span class="progress-text">
          <ng-container *ngIf="challenge()!.goalType === 'specific_summits'">
            {{ challenge()!.completedPeaks }} / {{ challenge()!.totalPeaks }} peaks
          </ng-container>
          <ng-container *ngIf="challenge()!.goalType === 'distance'">
            {{ (challenge()!.currentDistance / 1000) | number:'1.1-1' }} / {{ (challenge()!.targetValue! / 1000) | number:'1.1-1' }} km
          </ng-container>
          <ng-container *ngIf="challenge()!.goalType === 'elevation'">
            {{ challenge()!.currentElevation | number }} / {{ challenge()!.targetValue! | number }} m
          </ng-container>
          <ng-container *ngIf="challenge()!.goalType === 'summit_count'">
            {{ challenge()!.currentSummitCount }} / {{ challenge()!.targetSummitCount! }} summits
          </ng-container>
        </span>
      </div>

      <div class="progress-bar-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="progressPercentage()"></div>
        </div>
        <span class="percentage">{{ progressPercentage() }}%</span>
      </div>

      <div class="completion-badge" *ngIf="challenge()!.isCompleted">
        ğŸ‰ Challenge Completed!
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <div class="tabs">
      <button
        *ngIf="challenge()!.goalType === 'specific_summits'"
        class="tab"
        [class.active]="activeTab === 'peaks'"
        (click)="setTab('peaks')">
        Peaks ({{ peaks().length }})
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'participants'"
        (click)="setTab('participants')">
        Participants ({{ participants().length }})
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'activity'"
        (click)="setTab('activity')">
        Activity
      </button>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Peaks Tab (only for specific_summits goal type) -->
    <div class="peaks-tab" *ngIf="activeTab === 'peaks' && challenge()!.goalType === 'specific_summits'">
      <app-data-table
        *ngIf="peaks().length > 0"
        [columns]="peakColumns"
        [data]="peaks()"
        [config]="{ emptyMessage: 'No peaks in this challenge yet.' }"
      ></app-data-table>

      <div class="empty-state" *ngIf="peaks().length === 0">
        <p>No peaks in this challenge yet.</p>
      </div>
    </div>

    <!-- Participants Tab -->
    <div class="participants-tab" *ngIf="activeTab === 'participants'">
      <!-- Leaderboard for Competitive Challenges -->
      <div class="leaderboard-section" *ngIf="challenge()!.competitionMode === 'competitive'">
        <app-data-table
          *ngIf="leaderboard().length > 0"
          [columns]="leaderboardColumns()"
          [data]="leaderboard()"
          [config]="{ emptyMessage: 'No participants yet. Be the first to join!' }"
        ></app-data-table>

        <div class="empty-state" *ngIf="leaderboard().length === 0">
          <p>No participants yet. Be the first to join!</p>
        </div>
      </div>

      <!-- Regular Participants List for Collaborative Challenges -->
      <div class="collaborative-section" *ngIf="challenge()!.competitionMode === 'collaborative'">
        <app-data-table
          *ngIf="participants().length > 0"
          [columns]="collaborativeParticipantsColumns()"
          [data]="participants()"
          [config]="{ emptyMessage: 'No participants yet. Be the first to join!' }"
        ></app-data-table>

        <div class="empty-state" *ngIf="participants().length === 0">
          <p>No participants yet. Be the first to join!</p>
        </div>
      </div>
    </div>

    <!-- Activity Tab -->
    <div class="activity-tab" *ngIf="activeTab === 'activity'">
      <app-data-table
        *ngIf="activities().length > 0"
        [columns]="activityColumns()"
        [data]="activities()"
        [config]="{ emptyMessage: 'No activities yet. Start your challenge!' }"
      ></app-data-table>

      <div class="empty-state" *ngIf="activities().length === 0">
        <p>No activities yet. Start your challenge!</p>
      </div>
    </div>
  </div>
</div>

<ng-template #loading>
  <div class="loading-container">
    <p>Loading challenge...</p>
  </div>
</ng-template>
