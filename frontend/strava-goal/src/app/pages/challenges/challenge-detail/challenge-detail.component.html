<div class="challenge-detail-container" *ngIf="challenge(); else loading">
  <!-- Header -->
  <div class="detail-header">
    <button class="back-btn" (click)="goBack()">â† Back</button>
    
    <div class="header-content">
      <div class="title-row">
        <h1>{{ challenge()!.name }}</h1>
        <div class="badges">
          <span class="type-badge" [class]="challenge()!.challengeType">
            {{ challengeService.getChallengeTypeLabel(challenge()!.challengeType) }}
          </span>
          <span class="goal-type-badge">
            {{ challengeService.getGoalTypeIcon(challenge()!.goalType) }}
            {{ challengeService.getGoalTypeLabel(challenge()!.goalType) }}
          </span>
          <span class="mode-badge" [class]="challenge()!.competitionMode">
            {{ challenge()!.competitionMode === 'collaborative' ? 'ğŸ¤' : 'ğŸ†' }}
          </span>
          <span class="locked-badge" *ngIf="challenge()!.isLocked">
            ğŸ”’ Locked
          </span>
        </div>
      </div>
      
      <p class="description" *ngIf="challenge()!.description">
        {{ challenge()!.description }}
      </p>
      
      <div class="target-info" *ngIf="challengeService.formatTargetValue(challenge()!)">
        <span class="target-value">
          ğŸ¯ Goal: {{ challengeService.formatTargetValue(challenge()!) }}
        </span>
      </div>

      <div class="meta-info">
        <span *ngIf="challenge()!.region">ğŸ“ {{ challenge()!.region }}</span>
        <span *ngIf="challenge()!.difficulty"
          [style.color]="challengeService.getDifficultyColor(challenge()!.difficulty)">
          {{ challenge()!.difficulty }}
        </span>
        <span *ngIf="challenge()!.startDate">ğŸš€ Started: {{ formatDate(challenge()!.startDate) }}</span>
        <span *ngIf="challenge()!.deadline">ğŸ“… Due: {{ formatDate(challenge()!.deadline) }}</span>
      </div>

      <!-- Join Code Section (for creators) -->
      <div class="join-code-section" *ngIf="challenge()!.createdByUserId === currentUserId()">
        <button class="toggle-code-btn" (click)="toggleJoinCode()">
          {{ showJoinCode() ? 'ğŸ”½' : 'â–¶ï¸' }} Join Code
        </button>
        <div class="join-code-display" *ngIf="showJoinCode()">
          <span class="join-code-value">{{ challenge()!.joinCode }}</span>
          <button class="copy-btn" (click)="copyJoinCode()" title="Copy join code">
            ğŸ“‹ Copy
          </button>
        </div>
      </div>
    </div>

    <div class="header-actions">
      <button class="join-btn" *ngIf="!challenge()!.isJoined" (click)="onJoinChallenge()">
        Join Challenge
      </button>
      <button class="leave-btn" *ngIf="challenge()!.isJoined" (click)="onLeaveChallenge()">
        Leave
      </button>
      <button class="lock-btn" *ngIf="challenge()!.createdByUserId === currentUserId() && !challenge()!.isLocked" (click)="onLockChallenge()">
        ğŸ”’ Lock Challenge
      </button>
    </div>
  </div>

  <!-- Progress Section -->
  <div class="progress-section" *ngIf="challenge()!.isJoined">
    <div class="progress-card">
      <div class="progress-header">
        <h3>{{ challenge()!.competitionMode === 'collaborative' ? 'Team Progress' : 'Your Progress' }}</h3>
        <span class="progress-text">
          <ng-container *ngIf="challenge()!.goalType === 'specific_summits'">
            {{ challenge()!.completedPeaks }} / {{ challenge()!.totalPeaks }} peaks
          </ng-container>
          <ng-container *ngIf="challenge()!.goalType === 'distance'">
            {{ (challenge()!.currentDistance / 1000) | number:'1.1-1' }} / {{ (challenge()!.targetValue! / 1000) | number:'1.1-1' }} km
          </ng-container>
          <ng-container *ngIf="challenge()!.goalType === 'elevation'">
            {{ challenge()!.currentElevation | number }} / {{ challenge()!.targetValue! | number }} m
          </ng-container>
          <ng-container *ngIf="challenge()!.goalType === 'summit_count'">
            {{ challenge()!.currentSummitCount }} / {{ challenge()!.targetSummitCount! }} summits
          </ng-container>
        </span>
      </div>

      <div class="progress-bar-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="progressPercentage()"></div>
        </div>
        <span class="percentage">{{ progressPercentage() }}%</span>
      </div>

      <div class="completion-badge" *ngIf="challenge()!.isCompleted">
        ğŸ‰ Challenge Completed!
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <div class="tabs">
      <button
        *ngIf="challenge()!.goalType === 'specific_summits'"
        class="tab"
        [class.active]="activeTab === 'peaks'"
        (click)="setTab('peaks')">
        Peaks ({{ peaks().length }})
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'participants'"
        (click)="setTab('participants')">
        Participants ({{ participants().length }})
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'activity'"
        (click)="setTab('activity')">
        Activity
      </button>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Peaks Tab (only for specific_summits goal type) -->
    <div class="peaks-tab" *ngIf="activeTab === 'peaks' && challenge()!.goalType === 'specific_summits'">
      <!-- Remaining Peaks -->
      <div class="peaks-section" *ngIf="remainingPeaks.length > 0">
        <h3>ğŸ¯ To Summit ({{ remainingPeaks.length }})</h3>
        <div class="peaks-grid">
          <div class="peak-card" *ngFor="let peak of remainingPeaks">
            <div class="peak-icon">â›°ï¸</div>
            <div class="peak-details">
              <span class="peak-name">{{ peak.name }}</span>
              <span class="peak-alt" *ngIf="peak.altName">({{ peak.altName }})</span>
              <span class="peak-elevation">{{ peak.elevation }}m</span>
              <span class="peak-region" *ngIf="peak.region">{{ peak.region }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Completed Peaks -->
      <div class="peaks-section completed" *ngIf="completedPeaks.length > 0">
        <h3>âœ… Summited ({{ completedPeaks.length }})</h3>
        <div class="peaks-grid">
          <div class="peak-card summited" *ngFor="let peak of completedPeaks">
            <div class="peak-icon">âœ…</div>
            <div class="peak-details">
              <span class="peak-name">{{ peak.name }}</span>
              <span class="peak-alt" *ngIf="peak.altName">({{ peak.altName }})</span>
              <span class="peak-elevation">{{ peak.elevation }}m</span>
              <span class="peak-region" *ngIf="peak.region">{{ peak.region }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="peaks().length === 0">
        <p>No peaks in this challenge yet.</p>
      </div>
    </div>

    <!-- Participants Tab -->
    <div class="participants-tab" *ngIf="activeTab === 'participants'">
      <!-- Leaderboard for Competitive Challenges -->
      <div class="leaderboard-section" *ngIf="challenge()!.competitionMode === 'competitive' && leaderboard().length > 0">
        <h3>ğŸ† Leaderboard</h3>
        <div class="leaderboard">
          <div 
            class="leaderboard-row" 
            *ngFor="let entry of leaderboard()"
            [class.top3]="entry.rank <= 3"
            [class.completed]="entry.completedAt">
            <span class="rank">
              <ng-container *ngIf="entry.rank === 1">ğŸ¥‡</ng-container>
              <ng-container *ngIf="entry.rank === 2">ğŸ¥ˆ</ng-container>
              <ng-container *ngIf="entry.rank === 3">ğŸ¥‰</ng-container>
              <ng-container *ngIf="entry.rank > 3">#{{ entry.rank }}</ng-container>
            </span>
            
            <div class="participant-info">
              <a
                [href]="'https://www.strava.com/athletes/' + entry.stravaAthleteId"
                target="_blank"
                rel="noopener noreferrer"
                class="name-link">
                {{ entry.userName || entry.stravaAthleteId }}
              </a>
            </div>

            <div class="participant-progress">
              <span class="peaks-count">
                <ng-container *ngIf="challenge()!.goalType === 'specific_summits'">
                  {{ entry.peaksCompleted }}/{{ entry.totalPeaks }} peaks
                </ng-container>
                <ng-container *ngIf="challenge()!.goalType === 'distance'">
                  {{ (entry.totalDistance / 1000) | number:'1.1-1' }}/{{ (challenge()!.targetValue! / 1000) | number:'1.1-1' }} km
                </ng-container>
                <ng-container *ngIf="challenge()!.goalType === 'elevation'">
                  {{ entry.totalElevation | number }}/{{ challenge()!.targetValue! | number }} m
                </ng-container>
                <ng-container *ngIf="challenge()!.goalType === 'summit_count'">
                  {{ entry.totalSummitCount }}/{{ challenge()!.targetSummitCount! }} summits
                </ng-container>
              </span>
              <div class="mini-progress">
                <div
                  class="mini-fill"
                  [style.width.%]="entry.progress">
                </div>
              </div>
            </div>

            <span class="completed-badge" *ngIf="entry.completedAt">âœ…</span>
          </div>
        </div>
      </div>

      <!-- Regular Participants List for Collaborative Challenges -->
      <div class="leaderboard" *ngIf="challenge()!.competitionMode === 'collaborative' && sortedParticipants.length > 0">
        <div 
          class="participant-row" 
          *ngFor="let participant of sortedParticipants; let i = index">
          <div class="participant-info">
            <a
              [href]="'https://www.strava.com/athletes/' + participant.stravaAthleteId"
              target="_blank"
              rel="noopener noreferrer"
              class="name-link">
              {{ participant.userName || participant.stravaAthleteId }}
            </a>
          </div>

          <div class="participant-contribution">
            <span class="contribution-text">
              <ng-container *ngIf="challenge()!.goalType === 'specific_summits'">
                {{ participant.peaksCompleted }}/{{ participant.totalPeaks }} peaks
              </ng-container>
              <ng-container *ngIf="challenge()!.goalType === 'distance'">
                {{ (participant.totalDistance / 1000) | number:'1.1-1' }} km
              </ng-container>
              <ng-container *ngIf="challenge()!.goalType === 'elevation'">
                {{ participant.totalElevation | number }} m
              </ng-container>
              <ng-container *ngIf="challenge()!.goalType === 'summit_count'">
                {{ participant.totalSummitCount }} summits
              </ng-container>
            </span>
          </div>

          <span class="completed-badge" *ngIf="participant.completedAt">âœ…</span>
        </div>
      </div>

      <div class="empty-state" *ngIf="participants().length === 0 && leaderboard().length === 0">
        <p>No participants yet. Be the first to join!</p>
      </div>
    </div>

    <!-- Activity Tab -->
    <div class="activity-tab" *ngIf="activeTab === 'activity'">
      <div class="activity-feed" *ngIf="activities().length > 0">
        <div class="activity-item" *ngFor="let activity of activities()">
          <div class="activity-icon">ğŸƒ</div>
          <div class="activity-content">
            <div class="activity-header">
              <div class="activity-title-row">
                <a
                  [href]="'https://www.strava.com/activities/' + activity.strava_activity_id"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="activity-name">
                  {{ activity.name }}
                </a>
                <span class="activity-user">
                  by
                  <a
                    [href]="'https://www.strava.com/athletes/' + activity.stravaAthleteId"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="user-link">
                    {{ activity.userName || activity.stravaAthleteId }}
                  </a>
                </span>
              </div>
              <span class="activity-date">{{ formatDate(activity.start_date) }}</span>
            </div>
            <div class="activity-details">
              <!-- Peak names for summit challenges -->
              <div class="activity-peaks" *ngIf="activity.peakNames">
                <span class="peak-icon">ğŸ”ï¸</span>
                <span class="peak-list">{{ activity.peakNames }}</span>
              </div>
              <!-- Stats based on goal type -->
              <div class="activity-stats">
                <span *ngIf="challenge()!.goalType === 'distance'">
                  ğŸ“ {{ (activity.distance / 1000) | number:'1.1-1' }} km
                </span>
                <span *ngIf="challenge()!.goalType === 'elevation'">
                  â›°ï¸ {{ activity.total_elevation_gain | number:'1.0-0' }} m
                </span>
                <span *ngIf="challenge()!.goalType === 'summit_count' || challenge()!.goalType === 'specific_summits'">
                  ğŸ“ {{ (activity.distance / 1000) | number:'1.1-1' }} km
                  â€¢
                  â›°ï¸ {{ activity.total_elevation_gain | number:'1.0-0' }} m
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="activities().length === 0">
        <p>No activities yet. Start your challenge!</p>
      </div>
    </div>
  </div>
</div>

<ng-template #loading>
  <div class="loading-container">
    <p>Loading challenge...</p>
  </div>
</ng-template>
